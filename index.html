<script>
  window.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('optin-form');
    const submitBtn = document.getElementById('submitBtn');
    const errorMessage = document.getElementById('errorMessage');
    const phoneInput = form.querySelector('input[name="phone"]');

    function formatPhoneNumber(raw) {
      const digits = raw.replace(/\D/g, '');
      if (digits.length !== 10) return null;
      return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
    }

    let rawPhone = '';
    phoneInput.addEventListener('input', (e) => {
      rawPhone = e.target.value.replace(/\D/g, '').slice(0, 10);
      const parts = [];
      if (rawPhone.length > 0) parts.push('(' + rawPhone.slice(0, 3));
      if (rawPhone.length >= 4) parts.push(') ' + rawPhone.slice(3, 6));
      if (rawPhone.length >= 7) parts.push('-' + rawPhone.slice(6));
      e.target.value = parts.join('').replace(/\(\)/g, '');
    });

    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      errorMessage.style.display = 'none';

      const formData = new FormData(form);
      const data = Object.fromEntries(formData);

      const timestamp = new Date().toISOString();
      if (rawPhone.length !== 10) {
        errorMessage.textContent = 'Invalid phone number format.';
        errorMessage.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
        return;
      }

      const zapierWebhookUrl = 'https://hooks.zapier.com/hooks/catch/22996151/uoj2neb/';

      try {
        const payload = {
          firstName: data.firstName,
          lastName: data.lastName,
          email: data.email,
          phone: rawPhone,
          offers: data.offers || false,
          timestamp: timestamp
        };

        const zapRes = await fetch(zapierWebhookUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (zapRes.ok) {
          window.location.href = 'success.html';
        } else {
          throw new Error('Zapier webhook failed');
        }
      } catch (err) {
        console.error('Error:', err);
        errorMessage.textContent = "Something went wrong. Please try again later or call your sales rep at (858) 555-3421.";
        errorMessage.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
      }
    });
  });
</script>

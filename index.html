<!-- Full code unchanged except for the added `operation: "sms_optin_submit"` line in the payload -->
...
<script>
  function formatPhoneForAirtable(raw) {
    const digits = raw.replace(/\D/g, '');
    if (digits.length !== 10) return raw;
    return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
  }

  window.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('optin-form');
    const submitBtn = document.getElementById('submitBtn');
    const errorMessage = document.getElementById('errorMessage');
    const phoneInput = document.querySelector('input[name="phone"]');
    const emailInput = document.querySelector('input[name="email"]');

    const marketingOptIn = form.querySelector('input[name="marketing_optin"]');
    const transactionalOptIn = form.querySelector('input[name="transactional_optin"]');

    emailInput.insertAdjacentHTML('afterend', '<div class="inline-error" id="emailError"></div>');
    phoneInput.insertAdjacentHTML('afterend', '<div class="inline-error" id="phoneError"></div>');
    const emailError = document.getElementById('emailError');
    const phoneError = document.getElementById('phoneError');

    let rawPhone = '';

    phoneInput.addEventListener('input', (e) => {
      rawPhone = e.target.value.replace(/\D/g, '').slice(0, 10);
      const parts = [];
      if (rawPhone.length > 0) parts.push('(' + rawPhone.slice(0, 3));
      if (rawPhone.length >= 4) parts.push(') ' + rawPhone.slice(3, 6));
      if (rawPhone.length >= 7) parts.push('-' + rawPhone.slice(6));
      e.target.value = parts.join('').replace(/\(\)/g, '');

      if (rawPhone.length !== 10 && rawPhone !== '') {
        phoneError.textContent = 'Phone number must be 10 digits.';
        phoneError.style.display = 'block';
      } else {
        phoneError.style.display = 'none';
      }
    });

    emailInput.addEventListener('input', () => {
      const value = emailInput.value.trim();
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (value === '') {
        emailError.style.display = 'none';
      } else if (!emailPattern.test(value)) {
        emailError.textContent = 'Please enter a valid email address.';
        emailError.style.display = 'block';
      } else {
        emailError.style.display = 'none';
      }
    });

    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      errorMessage.style.display = 'none';

      const formData = new FormData(form);
      const data = Object.fromEntries(formData);
      const timestamp = new Date().toISOString();

      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailPattern.test(data.email)) {
        emailError.textContent = 'Please enter a valid email address.';
        emailError.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
        return;
      }

      if (rawPhone.length !== 10) {
        phoneError.textContent = 'Phone number must be 10 digits.';
        phoneError.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
        return;
      }

      if (!marketingOptIn.checked || !transactionalOptIn.checked) {
        errorMessage.textContent = 'Please agree to both SMS opt-in checkboxes before submitting.';
        errorMessage.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
        return;
      }

      const makeWebhookUrl = 'https://hook.us2.make.com/j158s4uo0wpdjmw185saw5962p16qsmf';

      try {
        const payload = {
          operation: "sms_optin_submit",  // âœ… Added identifier for Make.com
          firstName: data.firstName || '',
          lastName: data.lastName || '',
          email: data.email || '',
          phone: rawPhone,
          marketingOptIn: marketingOptIn.checked ? 'Yes' : 'No',
          transactionalOptIn: transactionalOptIn.checked ? 'Yes' : 'No',
          timestamp: timestamp
        };

        const response = await fetch(makeWebhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const raw = await response.text();
        let result;
        try {
          result = JSON.parse(raw);
        } catch (err) {
          result = null;
        }

        if (response.ok && result?.status === "success") {
          window.location.href = "success.html";
          return;
        }

        if (result?.status === "not_found") {
          errorMessage.textContent = "Sorry, we couldn't find you in our system.";
        } else {
          console.error("Unexpected response from Make:", raw);
          errorMessage.textContent = "Something went wrong. Please try again later.";
        }

        errorMessage.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';

      } catch (err) {
        console.error('Error:', err);
        errorMessage.textContent = "Something went wrong. Please try again later or call your sales rep at (858) 555-3421.";
        errorMessage.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
      }
    });
  });
</script>
...

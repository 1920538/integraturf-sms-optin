<script>
  window.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('optin-form');
    const submitBtn = document.getElementById('submitBtn');
    const errorMessage = document.getElementById('errorMessage');
    const phoneInput = form.querySelector('input[name="phone"]');

    function formatPhoneNumber(raw) {
      const digits = raw.replace(/\D/g, '');
      if (digits.length !== 10) return null;
      return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
    }

    // Live format while typing
    phoneInput.addEventListener('input', (e) => {
      const raw = e.target.value.replace(/\D/g, '').slice(0, 10);
      const parts = [];
      if (raw.length > 0) parts.push('(' + raw.slice(0, 3));
      if (raw.length >= 4) parts.push(') ' + raw.slice(3, 6));
      if (raw.length >= 7) parts.push('-' + raw.slice(6));
      e.target.value = parts.join('').replace(/\(\)/g, '');
    });

    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      submitBtn.disabled = true;
      submitBtn.textContent = 'Validating...';
      errorMessage.style.display = 'none';

      const formData = new FormData(form);
      const data = Object.fromEntries(formData);

      const timestamp = new Date().toISOString();
      const formattedPhone = formatPhoneNumber(data.phone);
      if (!formattedPhone) {
        errorMessage.textContent = 'Invalid phone number format.';
        errorMessage.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
        return;
      }

      const apiKey = 'patNz4xCr0JGARjOp.b26cc0771739a442aac15abd4a15f8cf540a4d34b5824adc063af66a44667227';
      const baseId = 'appySt7Fu5pPyR4jy';
      const sampleOrdersTable = 'Sample Orders';
      const smsTable = 'SMS';

      try {
        const queryUrl = `https://api.airtable.com/v0/${baseId}/${encodeURIComponent(sampleOrdersTable)}?filterByFormula=AND({Phone Number}='${formattedPhone}', {Customer Email}='${data.email}')`;
        const matchRes = await fetch(queryUrl, {
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        const matchData = await matchRes.json();

        if (matchData.records && matchData.records.length > 0) {
          const fullName = `${data.firstName} ${data.lastName}`;
          const record = {
            fields: {
              'Customer Name': fullName,
              'Customer Email': data.email,
              'Phone Number': formattedPhone,
              'Opt In Status': true,
              'Timestamp': timestamp,
            },
          };

          await fetch(`https://api.airtable.com/v0/${baseId}/${encodeURIComponent(smsTable)}`, {
            method: 'POST',
            headers: {
              Authorization: `Bearer ${apiKey}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(record),
          });

          window.location.href = 'success.html';
        } else {
          throw new Error('No match found');
        }
      } catch (err) {
        console.error('Error:', err);
        errorMessage.textContent = "We couldn't find a matching record. Please double-check your info or call your sales rep at (858) 555-3421.";
        errorMessage.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
      }
    });
  });
</script>
